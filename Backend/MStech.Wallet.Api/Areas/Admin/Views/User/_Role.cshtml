<!-- Select Role Modal -->

<div class="modal fade" id="ManageRoleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-centered modal-dialog-scrollable modal-lg" role="document">
        <form class="form form-800"
              enctype="multipart/form-data"
              method="post"
              id="ManageRoleForm"
              asp-area="Admin"
              asp-controller="User"
              asp-action="AddRoleToUser"
              data-ajax="true">

            <input type="hidden" id="UserId" name="UserId" />

            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title white" id="exampleModalCenterTitle">مدیریت نقش کاربر</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="بستن">
                        <i class="bx bx-x"></i>
                    </button>
                </div>
                <div class="modal-body">

                    <table id="ManageRole_Table" class="table table-hover table-bordered text-center mb-0">
                        <thead class="thead-dark">
                            <tr>
                                <th>نقش</th>
                                <th>دسترسی</th>
                            </tr>
                        </thead>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light-secondary" data-dismiss="modal">
                        <i class="bx bx-x d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">انصراف</span>
                    </button>
                    <button type="submit" class="btn btn-success ml-1">
                        <i class="bx bx-check d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">ثبت</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


<script type="text/javascript">
    var flag = 0;
    $(document).ready(function () {
        var manageRoleDataTable;
        loadManageRoleDataTable();
    });

    function loadManageRoleDataTable() {
        manageRoleDataTable = $('#ManageRole_Table').DataTable({
            "bAutoWidth": false,
            "processing": true,
            "serverSide": true,
            "searching": false,
            "paging": false,
            "info": false,
            "ajax": function (data, callback, settings) {  // Make the Ajax call ourselves
                $.ajax({
                    url: '@Url.Action("RoleDataTable", "Role", new { Area = "Membership" })',
                    type: "POST",
                    async: true,
                    dataType: "json",
                    data: {
                        columns: data.columns,
                        draw: data.draw,
                        length: 100,
                        order: data.order,
                        search: data.search,
                        start: 0,
                        filter: getFilterManageRoleDataTable()
                    }
                }).done(function (data, textStatus, jqXHR) {
                    flag = 0;
                    callback(data);
                })
            },
            "columns": [
                { "name": "PersianName", "data": "persianName", "orderable": true, "searchable": true, },
                {
                    "name": "Status",
                    "data": "status",
                    "orderable": false,
                    "searchable": false,
                    "render": function (data, type, full, meta) {
                        var result = full.isSelected
                            ? `<div class="checkbox"><input type="checkbox" class="checkbox-input" id="RoleIds[${flag}]" name="RoleIds" value="${full.id}" checked/><label for="RoleIds[${flag}]"></label></div>`
                            : `<div class="checkbox"><input type="checkbox" class="checkbox-input" id="RoleIds[${flag}]" name="RoleIds" value="${full.id}" /><label for="RoleIds[${flag}]"></label></div>`;
                        flag = flag + 1;
                        return result;
                    },
                },
            ],
            "rowCallback": function (row, data, index) {
            }
        });
    }

    function getFilterManageRoleDataTable() {
        var filter = {
            "UserId": $('#ManageRoleForm #UserId').val(),
        };
        return filter;
    }

    function reloadManageRoleDataTable() {
        manageRoleDataTable.ajax.reload();
    }

    $('#ManageRoleForm').submit(function (e) {

        e.preventDefault();

        var action = $(this).attr('action');
        var formData = new FormData($(this).get(0));

        $.ajax({
            type: "POST",
            dataType: "json",
            url: action,
            data: formData,
            processData: false,
            contentType: false,
            success: function (data, status, settings) {
                if (data.status) {
                    toastr.success('مدیریت نقش کاربر با موفقیت انجام شد.', 'عملیات موفق', {
                        rtl: true,
                        positionClass: 'toast-bottom-right',
                        containerId: 'toast-bottom-right'
                    });
                    reloadUserDataTable();
                    $('#ManageRoleModal').modal('toggle');
                }
                else {
                    toastr.error(data.message, 'اخطار!', {
                        rtl: true,
                        positionClass: 'toast-bottom-right',
                        containerId: 'toast-bottom-right'
                    });
                }
            },
            error: function (request, options, err) {
                $(".loader-box").css("display", "none");
                var message = 'عملیات با خطا مواجه شد.';
                if (xhr.status == 403) {
                    message = 'دسترسی این عملیات را ندارید.';
                }
                toastr.error(`${message}`, 'اخطار!', {
                    rtl: true,
                    positionClass: 'toast-bottom-right',
                    containerId: 'toast-bottom-right'
                });
            }
        });
    });


</script>
