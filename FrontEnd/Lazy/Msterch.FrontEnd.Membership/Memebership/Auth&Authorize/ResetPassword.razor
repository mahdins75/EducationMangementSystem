@page "/Membership/ResetPassword"

@using Mstech.Frontend.Wallet.Service.Interface.Membership
@using Mstech.Frontend.Wallet.ViewModel.DTO
@inject IUserService userService
@inject SweetAlertService SweetAlert
@inject NavigationManager NavigationManager



<div class="d-flex justify-content-center align-items-center vh-100">
    <div class="card text-right" style="width: 50rem;">
        <div class="card-header header-color bg-primary text-white text-left">
            ورود به حساب کاربری
        </div>
        <div class="card-body">
            <EditForm Model="ResetPasswordViewModel" OnValidSubmit="@(() => HandleResetPassword())">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="form-group">
                    <label for="UserName">نام کاربری:</label>
                    <InputText  @bind-Value="ResetPasswordViewModel.UserName" class="form-control" />
                    <ValidationMessage For="@(() => ResetPasswordViewModel.UserName)" />
                </div>
                <div class="form-group">
                    <label for="Password">رمز عبور:</label>
                    <InputText @bind-Value="ResetPasswordViewModel.NewPassword" class="form-control" />
                    <ValidationMessage For="@(() => ResetPasswordViewModel.NewPassword)" />
                </div>
                <div class="form-group">
                    <label for="ConfirmPassword">رمز عبور:</label>
                    <InputText @bind-Value="ResetPasswordViewModel.ConfirmPassword" class="form-control" />
                    <ValidationMessage For="@(() => ResetPasswordViewModel.ConfirmPassword)" />
                </div>
                <button type="submit" class="btn btn-primary btn-color w-80 mt-2">ورود</button>

            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private ResetPasswordViewModel ResetPasswordViewModel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ResetPasswordViewModel = new ResetPasswordViewModel();

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);

        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        ResetPasswordViewModel.UserName = query["username"].ToString();
        ResetPasswordViewModel.Token = query["token"].ToString();

        base.OnInitialized();
    }
    private async Task ConfirmRegistrationHandler()
    {

    }

    private async Task HandleResetPassword()
    {
        var result = await userService.ResetPassword(ResetPasswordViewModel);
        if (!result.IsSuccess)
        {

            if ((result.ErrorCode != null && result.ErrorCode == "Unauthorized") || (result.ErrorCode != null && result.ErrorCode == "Forbidden"))
            {
                var currentPath = new Uri(NavigationManager.Uri).AbsolutePath;

                if (currentPath.ToLower() != "/Membership/Login".ToLower() && currentPath.ToLower() != "/Membership/Register".ToLower())
                {
                    NavigationManager.NavigateTo("/membership/Login");
                }

            }
            else
            {
                await SweetAlert.ShowAlert("خطا !", result.Message, "error");
            }

        }
        else
        {
            try
            {
                await userService.GetUserInfo();
            }
            catch
            {

            }

            await SweetAlert.ShowAlert("ورد با موفقیت انجام شد !", result.Message, "success");

            NavigationManager.NavigateTo("/WalletInfo/Wallet/DashBoard", forceLoad: true);

        }
    }


}
