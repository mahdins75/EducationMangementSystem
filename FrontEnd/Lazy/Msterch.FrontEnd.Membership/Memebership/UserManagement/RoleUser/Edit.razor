@* @page "/Membership/User/Edit"

@inject IUserService userService
@inject IGetDropDownDataService getDropDownDataService
@inject NavigationManager NavigationManager
@inject SweetAlertService SweetAlert


<div class="modal @modalDisplayClass fade show d-block " tabindex="-1" role="dialog" style="background-color: rgba(0, 0, 0, 0.5); display:@modalStyle;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ویرایش کاربر</h5>
                <button type="button" class="close" @onclick="HideEditModal"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="editUser" OnValidSubmit="@(() => EditUser())">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <input type="hidden" @bind="editUser.Id" />
                    <div class="row">
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(UserViewModel.Name))</label>
                            <InputText class="form-control" @bind-Value="editUser.Name" />
                            <ValidationMessage For="@(() => editUser.Name)" />

                        </div>
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(UserViewModel.LastName))</label>
                            <InputText class="form-control" @bind-Value="editUser.LastName" />
                            <ValidationMessage For="@(() => editUser.LastName)" />

                        </div>
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(UserViewModel.UserName))</label>
                            <InputText class="form-control" @bind-Value="editUser.UserName" />
                            <ValidationMessage For="@(() => editUser.UserName)" />

                        </div>
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(UserViewModel.PhoneNumber))</label>
                            <InputText class="form-control" @bind-Value="editUser.PhoneNumber" />
                            <ValidationMessage For="@(() => editUser.PhoneNumber)" />

                        </div>

                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(UserViewModel.Address))</label>
                            <InputTextArea class="form-control" @bind-Value="editUser.Address" />
                        </div>

                    </div>
                    <!-- Save Button -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary" @onclick="EditUser">ذخیره تغییرات</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>


@code {
    RadzenDropDown<int> statusDropDown = new();

    RadzenDropDown<string> ownerDropDown = new();


    private UserViewModel editUser { get; set; }

    [Parameter]
    public List<SelectListItem> statusDropDownData { get; set; }

    [Parameter]
    public List<SelectListItemStringValue> ownerDropDownData { get; set; }

    [Parameter]
    public RadzenDataGrid<UserViewModel> grid { get; set; }

    private string modalDisplayClass = "";

    private string modalStyle = "none !important";

    int count;

    bool isLoading = false;


    protected override async Task OnInitializedAsync()
    {
        editUser = new();
        statusDropDownData = new();
        ownerDropDownData = new();
        var adasd = statusDropDownData;
        StateHasChanged();
    }

    string GetDisplayName(string propertyName)
    {
        var prop = typeof(UserViewModel).GetProperty(propertyName);
        if (prop != null)
        {
            var displayAttr = prop.GetCustomAttributes(typeof(DisplayAttribute), false).FirstOrDefault() as DisplayAttribute;
            if (displayAttr != null)
            {
                return displayAttr.Name;
            }
        }
        return propertyName; // Fallback to property name if Display is not set
    }

    async Task<UserViewModel> LoadSingleForEdit(string id)
    {

        var query = await userService.GetAllUsers(new UserViewModel() { Id = id, IsPagination = false });

        if (query?.Entity != null)
        {
            return query.Entity.FirstOrDefault();
        }
        else
        {
            return new UserViewModel();
        }
    }
    public async Task OpenEditModal(UserViewModel User)
    {

        editUser = await LoadSingleForEdit(User.Id);
        modalDisplayClass = "show";
        modalStyle = "block";
        StateHasChanged();
    }
    async Task EditUser()
    {
        var result = await userService.UpdateUser(new UserViewModel
            {
                Id = editUser.Id,
                Name = editUser.Name,
                UserName = editUser.UserName,
                LastName = editUser.LastName,
                PhoneNumber = editUser.PhoneNumber,
                Password = editUser.Password,
                ConfirmPassword = editUser.ConfirmPassword,
                Address = editUser.Address,
                Status = editUser.Status,
                IsActive = editUser.IsActive

            });
        if (!result.IsSuccess)
        {
            if ((result.ErrorCode != null && result.ErrorCode == "Unauthorized") || (result.ErrorCode != null && result.ErrorCode == "Forbiden"))
            {
                NavigationManager.NavigateTo("");

            }
            else
            {
                await SweetAlert.ShowAlert("خطا !", result.Message, "error");

            }

        }
        else
        {
            editUser = new UserViewModel();
        }
        HideEditModal();
        await grid.Reload();
    }

    private void HideEditModal()
    {
        modalDisplayClass = "hide ";
        modalStyle = "none !important";
        StateHasChanged();
    }



}
 *@