@page "/Membership/ًRole/Edit"

@inject IRoleService roleService
@inject IGetDropDownDataService getDropDownDataService
@inject NavigationManager NavigationManager
@inject SweetAlertService SweetAlert


<div class="modal @modalDisplayClass fade show d-block " tabindex="-1" role="dialog" style="background-color: rgba(0, 0, 0, 0.5); display:@modalStyle;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ویرایش کاربر</h5>
                <button type="button" class="close" @onclick="HideEditModal"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="editRole" OnValidSubmit="@(() => EditRole())">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <input type="hidden" @bind="editRole.Id" />
                    <div class="row">
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(RoleViewModel.Name))</label>
                            <InputText class="form-control" @bind-Value="editRole.Name" />
                            <ValidationMessage For="@(() => editRole.Name)" />

                        </div>
                        <div class="col-md-3">
                            <label>@GetDisplayName(nameof(RoleViewModel.PersianName))</label>
                            <InputText class="form-control" @bind-Value="editRole.PersianName" />
                            <ValidationMessage For="@(() => editRole.PersianName)" />

                        </div>

                    </div>
                    <!-- Save Button -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" disabled="@isProcessing" class="btn btn-primary">ذخیره تغییرات</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>
@if (isProcessing)
{
    <div class="loading-overlay">
        <RadzenProgressBarCircular ProgressBarStyle="ProgressBarStyle.Primary"
                                   Value="100"
                                   ShowValue="false"
                                   Mode="ProgressBarMode.Indeterminate" />
        <div class="loading-text">لطفا صبر کنید...</div>
    </div>
}

@code {


    private RoleViewModel editRole { get; set; }


    [Parameter]
    public RadzenDataGrid<RoleViewModel> grid { get; set; }

    private string modalDisplayClass = "";

    private string modalStyle = "none !important";

    int count;

    bool isLoading = false;

    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        editRole = new();
        StateHasChanged();
    }

    string GetDisplayName(string propertyName)
    {
        var prop = typeof(RoleViewModel).GetProperty(propertyName);
        if (prop != null)
        {
            var displayAttr = prop.GetCustomAttributes(typeof(DisplayAttribute), false).FirstOrDefault() as DisplayAttribute;
            if (displayAttr != null)
            {
                return displayAttr.Name;
            }
        }
        return propertyName; // Fallback to property name if Display is not set
    }

    async Task<RoleViewModel> LoadSingleForEdit(int id)
    {

        var query = await roleService.GetAll(new RoleViewModel() { Id = id, IsPagination = false });

        if (query?.Entity != null)
        {
            return query.Entity.FirstOrDefault();
        }
        else
        {
            return new RoleViewModel();
        }
    }
    public async Task OpenEditModal(RoleViewModel User)
    {

        editRole = await LoadSingleForEdit(User.Id);
        modalDisplayClass = "show";
        modalStyle = "block";
        StateHasChanged();
    }
    async Task EditRole()
    {

        if (isProcessing) return;

        isProcessing = true;
        StateHasChanged();

        var result = await roleService.Edit(new RoleViewModel
            {
                Id = editRole.Id,
                Name = editRole.Name,
                PersianName = editRole.PersianName

            });
        if (!result.IsSuccess)
        {
            if ((result.ErrorCode != null && result.ErrorCode == "Unauthorized") || (result.ErrorCode != null && result.ErrorCode == "Forbiden"))
            {
                NavigationManager.NavigateTo("");

            }
            else
            {
                await SweetAlert.ShowAlert("خطا !", result.Message, "error");

            }

        }
        else
        {
            editRole = new RoleViewModel();
        }

        isProcessing = false;
        StateHasChanged();
        HideEditModal();

        await grid.Reload();
    }

    private void HideEditModal()
    {
        modalDisplayClass = "hide ";
        modalStyle = "none !important";
        StateHasChanged();
    }



}
